name: AnyDesk Official CLI Setup

on:
  workflow_dispatch:

jobs:
  run-anydesk:
    runs-on: windows-2022
    steps:
      - name: 1. Install & Connect Tailscale
        shell: powershell
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.92.3-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=gh-runner-${{ github.run_id }}
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          "TAILSCALE_IP=$tsIP" | Out-File -Append $env:GITHUB_ENV

      - name: 3. Official AnyDesk Installation & Logic
        shell: cmd
        run: |
          echo [INFO] Downloading Official AnyDesk.exe...
          powershell -Command "Invoke-WebRequest -Uri 'https://download.anydesk.com/AnyDesk.exe' -OutFile 'AnyDesk.exe'"
          
          echo [INFO] Installing AnyDesk Silently...
          AnyDesk.exe --install "C:\AnyDesk" --start-with-win --silent
          
          echo [INFO] Waiting 20s for installation...
          powershell -Command "Start-Sleep -Seconds 20"
          
          set "adPath=C:\AnyDesk\AnyDesk.exe"

          if not exist "%adPath%" (
              echo [ERROR] AnyDesk was not found!
              exit 1
          )

          :START_ANYDESK
          echo [INFO] Starting AnyDesk service in background...
          start "" "%adPath%" --start
          powershell -Command "Start-Sleep -Seconds 10"

          echo [INFO] Attempting to fetch AnyDesk ID...
          for /f "delims=" %%i in ('"%adPath%" --get-id') do (
              set "ID=%%i"
          )

          if "%ID%"=="" (
              echo [WARNING] ID is empty, retrying...
              taskkill /f /im anydesk.exe > nul 2>&1
              goto START_ANYDESK
          )
          if "%ID%"=="0" (
              echo [WARNING] ID is 0, retrying...
              taskkill /f /im anydesk.exe > nul 2>&1
              goto START_ANYDESK
          )
          
          echo [SUCCESS] Valid ID found: %ID%
          echo [INFO] Setting password for Full Access...
          echo MR.English2008 | "%adPath%" --set-password _full_access
          
          echo ANYDESK_ID=%ID% >> %GITHUB_ENV%

      - name: 4. Final Status & Keep Alive
        shell: powershell
        run: |
          $endTime = (Get-Date).AddHours(6)
          Write-Host "========================================"
          Write-Host "ANYDESK READY"
          Write-Host "ID: $env:ANYDESK_ID"
          Write-Host "User: runneradmin"
          Write-Host "Password: MR.English2008"
          Write-Host "========================================"
          
          while ((Get-Date) -lt $endTime) {
              Write-Host "Online | ID: $env:ANYDESK_ID | $(Get-Date)"
              Start-Sleep -Seconds 300
          }