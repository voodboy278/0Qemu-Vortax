name: Qemu-Vortax V 1.1

on:
  workflow_dispatch:
    inputs:
      system_choice:
        description: 'Choose a ready system (mint, pear, bazite, kali, bliss_free, bliss_gapps, neon, deepin, garuda_mokka, ubuntu, popos, debian_qcow2, centos_qcow2, kali_qcow2)'
        required: false
        default: ''
      boot_mode:
        description: 'Choose boot type: iso or qcow2'
        required: true
        default: 'iso'
      source_url:
        description: 'Custom source URL (optional)'
        required: false
        default: ''
      vm_name:
        description: 'Name of the system/disk'
        required: true
        default: 'ME2008'
      runtime:
        description: 'Runtime duration in minutes (default 350)'
        required: false
        default: '350'

permissions:
  contents: read

jobs:
  setup-and-run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      USERNAME: runner
      PASSWORD: runner
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      FINAL_SOURCE_URL: ''
      RUNNER_TEMP: /mnt/tmp
      ACTIONS_RUNNER_CACHE: /mnt/cache

    steps:
      - uses: actions/checkout@v4
      - name: Prepare user and sudo
        run: |
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}
          sudo mkdir -p /mnt/tmp /mnt/cache
          sudo chmod -R 777 /mnt/tmp /mnt/cache
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          sudo tailscale up --authkey "${TAILSCALE_AUTHKEY}" --hostname "gh-xfce-vm-${{ github.run_id }}" --accept-routes --accept-dns=false
          TS_IP=$(sudo tailscale ip -4 | head -n1)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
      - name: Install XFCE + RDP + NoMachine + SSH/X
        run: |
          sudo apt-get update -qq
          sudo apt install -y tigervnc-viewer wmctrl wget
          wget -q https://web9001.nomachine.com/download/9.2/Linux/nomachine_9.2.18_3_amd64.deb -O nomachine.deb
          sudo dpkg -i nomachine.deb || sudo apt-get -f install -y
          rm nomachine.deb
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq xfce4 xfce4-goodies xorg dbus-x11 xrdp
          echo "startxfce4" | sudo tee /home/${USERNAME}/.xsession
          sudo chown ${USERNAME}:${USERNAME} /home/${USERNAME}/.xsession
          echo "exec startxfce4" | sudo tee /etc/skel/.xsession
          echo "startxfce4" | sudo tee /etc/skel/.xinitrc
          sudo ufw allow 4000/tcp
          sudo ufw allow 4011:4999/tcp
          sudo ufw allow 5900/tcp
          sudo ufw allow 3389/tcp
          sudo ufw --force enable || true
          sudo systemctl enable --now xrdp
          sudo systemctl restart xrdp
      - name: Install QEMU and components
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq qemu-system-x86 ovmf novnc websockify wget curl unzip p7zip-full unrar-free tar
          git clone https://github.com/stck-lzm/badown ~/badown
          chmod +x ~/badown/badown
      
      - name: Determine source URL
        id: determine_url
        run: |
          CHOICE="${{ github.event.inputs.system_choice }}"
          USER_URL="${{ github.event.inputs.source_url }}"
          
          declare -A ISO_URLS
          ISO_URLS["mint"]="https://pub.linuxmint.io/stable/22.2/linuxmint-22.2-cinnamon-64bit.iso"
          ISO_URLS["pear"]="https://eu-east-cdn.pearos.xyz/pearOS-NiceC0re-2025.11-x86_64.iso"
          ISO_URLS["bazite"]="https://download.bazzite.gg/bazzite-stable-live.iso"
          ISO_URLS["kali"]="https://kali.download/base-images/kali-2025.3/kali-linux-2025.3-live-amd64.iso"
          ISO_URLS["bliss_gapps"]="https://dn720203.ca.archive.org/0/items/Bliss-v15.9-x86_64-OFFICIAL-gapps-20240114/Bliss-v15.9-x86_64-OFFICIAL-gapps-20240114.iso"
          ISO_URLS["neon"]="https://mirrors.xtom.de/kde-application/neon/images/user/current/neon-user-current.iso"
          ISO_URLS["deepin"]="https://cdimage-cdn77.deepin.com/deepin-cd/25.0.1/amd64/deepin-desktop-community-25.0.1-amd64.iso"
          ISO_URLS["garuda_mokka"]="https://r2.garudalinux.org/iso/garuda/mokka/251002/garuda-mokka-linux-zen-251002.iso?r2request"
          ISO_URLS["ubuntu"]="https://releases.ubuntu.com/25.10/ubuntu-25.10-desktop-amd64.iso"
          ISO_URLS["popos"]="https://iso.pop-os.org/22.04/amd64/intel/58/pop-os_22.04_amd64_intel_58.iso"
          ISO_URLS["manjaro"]="https://download.manjaro.org/gnome/25.0.10/manjaro-gnome-25.0.10-251013-linux612.iso"
          ISO_URLS["cutefish"]="https://netix.dl.sourceforge.net/project/cutefish-ubuntu/ISO/Ubuntu/CutefishOS-22.04.0-YoYo-beta-amd64.iso?viasf=1"
          
          declare -A QCOW2_URLS
          QCOW2_URLS["debian_qcow2"]="https://chuangtzu.ftp.acc.umu.se/images/cloud/bookworm/20251006-2257/debian-12-generic-amd64-20251006-2257.qcow2"
          QCOW2_URLS["centos_qcow2"]="https://cloud.centos.org/centos/10-stream/x86_64/images/CentOS-Stream-GenericCloud-x86_64-10-latest.x86_64.qcow2"
          QCOW2_URLS["kali_qcow2"]="https://kali.mirror.garr.it/kali-images/current/kali-linux-2025.3-qemu-amd64.7z"

          DEFAULT_URL="${ISO_URLS["bliss_gapps"]}"
          FINAL_URL=""
          
          if [[ -n "$CHOICE" ]]; then
            if [[ "${ISO_URLS[$CHOICE]}" ]]; then
              FINAL_URL="${ISO_URLS[$CHOICE]}"
            elif [[ "${QCOW2_URLS[$CHOICE]}" ]]; then
              FINAL_URL="${QCOW2_URLS[$CHOICE]}"
            fi
          fi
          
          if [[ -n "$USER_URL" ]]; then
            FINAL_URL="$USER_URL"
          elif [[ -z "$FINAL_URL" ]]; then
             FINAL_URL="$DEFAULT_URL"
          fi
          
          echo "FINAL_SOURCE_URL=$FINAL_URL" >> $GITHUB_ENV

      - name: Configure VM specs
        run: |
          DISK=60
          if [ "${{ github.event.repository.private }}" = "true" ]; then
            RAM=6
          else
            RAM=14
          fi
          VCPUS=2
          echo "RAM=$RAM" >> $GITHUB_ENV
          echo "DISK=$DISK" >> $GITHUB_ENV
          echo "VCPUS=$VCPUS" >> $GITHUB_ENV
          
      - name: Prepare files and disks
        run: |
          MODE="${{ github.event.inputs.boot_mode }}"
          SRC="${{ env.FINAL_SOURCE_URL }}"
          VM="${{ github.event.inputs.vm_name }}"
          DISK="${{ env.DISK }}"
          HOME_PATH="$HOME"
          MNT_PATH="/mnt"
          TEMP_PATH="/mnt/tmp_unpack"
          FILE_PATH="$TEMP_PATH/source_file"
          sudo mkdir -p "$TEMP_PATH"
          if [[ "$SRC" == *"mediafire.com"* || "$SRC" == *"mega.nz"* ]]; then
            echo "Using badown to download from: $SRC"
            cd ~/badown
            sudo ./badown "$SRC"
            DOWNLOADED=$(ls -t | head -n1)
            sudo mv "$DOWNLOADED" "$FILE_PATH"
          else
            echo "Downloading system file via wget..."
            sudo wget -q --user-agent="Mozilla/5.0" --trust-server-names --content-disposition -O "$FILE_PATH" "$SRC"
          fi
          EXT=$(file -b --mime-type "$FILE_PATH")
          if [[ "$EXT" == *"iso"* && "$MODE" == "iso" ]]; then
            sudo mv "$FILE_PATH" "$HOME_PATH/${VM}.iso"
            sudo qemu-img create -f qcow2 "$MNT_PATH/${VM}.qcow2" "${DISK}G"
          elif [[ "$EXT" == *"iso"* && "$MODE" == "qcow2" ]]; then
            echo "::warning title=ISO Detected::User chose qcow2 mode but ISO provided. Proceeding with ISO."
            sudo mv "$FILE_PATH" "$HOME_PATH/${VM}.iso"
            sudo qemu-img create -f qcow2 "$MNT_PATH/${VM}.qcow2" "${DISK}G"
          elif [[ "$EXT" == *"zip"* || "$EXT" == *"7z"* || "$EXT" == *"rar"* || "$EXT" == *"tar"* || "$EXT" == *"gzip"* ]]; then
            cd "$TEMP_PATH"
            if [[ "$EXT" == *"zip"* ]]; then
              sudo unzip -q "$FILE_PATH" -d "$TEMP_PATH"
            elif [[ "$EXT" == *"7z"* ]]; then
              sudo 7z x -y "$FILE_PATH" > /dev/null
            elif [[ "$EXT" == *"rar"* ]]; then
              sudo unrar x -inul "$FILE_PATH"
            else
              sudo tar -xf "$FILE_PATH"
            fi
            FOUND=$(find "$TEMP_PATH" -type f \( -iname "*.qcow2" -o -iname "*.img" \) | head -n 1)
            if [ -n "$FOUND" ]; then
              sudo mv "$FOUND" "$MNT_PATH/${VM}.qcow2"
            else
              echo "::error::No QCOW2 or IMG found inside archive."
              exit 1
            fi
          else
            sudo mv "$FILE_PATH" "$MNT_PATH/${VM}.qcow2"
          fi

          sudo rm -rf "$TEMP_PATH"

      - name: Run the VM 
        run: |
          MODE="${{ github.event.inputs.boot_mode }}"
          VM="${{ github.event.inputs.vm_name }}"
          VCPUS="${{ env.VCPUS }}"
          RAM="${{ env.RAM }}"
          HOME_PATH="$HOME"
          MNT_PATH="/mnt"
          ISO_PATH="$HOME_PATH/${VM}.iso"
          DISK_PATH="$MNT_PATH/${VM}.qcow2"

          echo "Starting the virtual machine..."
          if [ "$MODE" = "iso" ]; then
            sudo qemu-system-x86_64 -enable-kvm -m ${RAM}G -smp ${VCPUS} -boot d -cdrom "$ISO_PATH" -drive file="$DISK_PATH",format=qcow2 -vnc :0 -cpu host -display none -name "$VM" -netdev user,id=net0,hostfwd=tcp::2222-:22 -device e1000,netdev=net0,id=net0,mac=52:54:00:c9:18:27 &
            
          else
            sudo qemu-system-x86_64 -enable-kvm -m ${RAM}G -smp ${VCPUS} -drive file="$DISK_PATH",format=qcow2 -vnc :0 -cpu host -display none -name "$VM" -netdev user,id=net0,hostfwd=tcp::2222-:22 -device e1000,netdev=net0,id=net0,mac=52:54:00:c9:18:27 &
          fi
          echo "VM started successfully."


      - name: Create desktop VNC launcher
        run: |
          DESKTOP_PATH="/home/${USERNAME}/Desktop"
          SCRIPT_PATH="${DESKTOP_PATH}/Connect_VNC.sh"
          mkdir -p "$DESKTOP_PATH"
          cat <<EOF > "$SCRIPT_PATH"
          vncviewer ${{ env.TAILSCALE_IP }}:5900 -FullScreen -MenuKey F8 &
          sleep 3 && wmctrl -r "VNC Viewer" -b add,above
          EOF
          chmod +x "$SCRIPT_PATH"
          chown ${USERNAME}:${USERNAME} "$SCRIPT_PATH"
          echo " Desktop launcher created at: $SCRIPT_PATH"
          echo " Press F8 inside the VNC window to open the control menu (exit fullscreen)"
          
      - name: Connection Information and Keep Alive
        run: |
          echo "Thanks to MR.English2008 for this perfect work"
          echo
          echo "=== CONNECTION INFORMATION ==="
          echo "RDP Username: ${USERNAME}"
          echo "RDP Password: ${PASSWORD}"
          echo "Tailscale IP:"
          sudo tailscale ip -4 || true
          echo
          echo ">>> RDP Connection:"
          echo " ${TAILSCALE_IP}"
          echo
          echo ">>> VNC Connection:"
          echo " ${TAILSCALE_IP}:5900"
          echo
          echo ">>> NoMachine Connection:"
          echo " ${TAILSCALE_IP}:4000"
          echo
          echo "NOTE: if you connect with RDP or VNC you have to click on Connect_VNC.sh to open the qemu VM"
          echo
          echo "NOTE: if you did connect with RDP or NoMachine and open Connect_VNC.sh you will not be able to connect to VNC unless you disconnect from RDP or NoMachine"
          echo
          echo "NOTE: to disconnect type F8 from clint keyboard a menu will appear click on Disconnect then you will be able to connect with VNC viewer again "
          echo
          echo "Have fun ðŸ˜Š "
          RUNTIME="${{ github.event.inputs.runtime }}"
          echo "Keeping the session alive for ${RUNTIME} minutes..."
          sleep $((RUNTIME * 60))
          echo "Session ended after ${RUNTIME} minutes."
